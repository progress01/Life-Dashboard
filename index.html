<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Dashboard V19.2</title>
    <style>
        /* --- å…¨åŸŸé¢¨æ ¼ --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            display: flex; flex-direction: column; align-items: center;
            padding: 20px; margin: 0;
            transition: background 0.5s;
        }

        /* --- å°èˆªåˆ— --- */
        .nav-bar { width: 100%; max-width: 800px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; }
        .switch-container { background: #161b22; padding: 4px; border-radius: 30px; border: 1px solid #30363d; display: flex; gap: 4px; flex: 1; justify-content: center; }
        .switch-btn { background: transparent; border: none; color: #8b949e; padding: 8px 20px; font-size: 14px; font-weight: bold; cursor: pointer; border-radius: 25px; transition: 0.3s; white-space: nowrap; }
        
        .switch-btn.active { background: #238636; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .switch-btn.active[data-mode="money"] { background: #d29922; color: #1e1e1e; }
        .switch-btn.active[data-mode="reward"] { background: #a371f7; color: #fff; } 

        .settings-btn { background: #21262d; border: 1px solid #30363d; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; color: #8b949e; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .settings-btn:hover { color: #58a6ff; transform: rotate(90deg); border-color: #58a6ff; }

        h2 { margin: 0 0 15px 0; font-weight: 600; letter-spacing: 1px; font-size: 1.5rem; text-align: center; }

        /* --- é€šç”¨å®¹å™¨ --- */
        .dashboard-view { width: 100%; max-width: 900px; display: flex; flex-direction: column; align-items: center; animation: fadeIn 0.5s ease; }
        .hidden { display: none !important; }

        /* --- é‡‘å¥å¡ç‰‡ --- */
        .quote-container { 
            background-color: #161b22; 
            background-size: cover; 
            background-position: center; 
            border: 1px solid #30363d; 
            border-left: 5px solid #58a6ff; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            width: 100%; 
            min-height: 120px; 
            display: flex; 
            align-items: center; 
            position: relative; 
            overflow: hidden; 
            transition: 0.5s; 
            box-sizing: border-box; 
            cursor: pointer; 
            user-select: none; 
        }
        .quote-container:active { transform: scale(0.98); opacity: 0.9; }
        
        .quote-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, rgba(13,17,23,0.95) 0%, rgba(13,17,23,0.4) 100%); z-index: 1; }
        .quote-content-layer { position: relative; z-index: 2; padding: 20px; width: 100%; box-sizing: border-box; pointer-events: none; }
        .quote-text { font-size: 1.1rem; font-weight: 500; color: #fff; font-family: serif; margin-bottom: 8px; line-height: 1.4; text-shadow: 0 2px 4px rgba(0,0,0,0.5); white-space: pre-line; }
        .quote-author { font-size: 0.9rem; color: #e6edf3; text-align: right; display: block; font-weight: bold; text-transform: uppercase; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        /* --- æ•¸æ“šçµ±è¨ˆ --- */
        .stats-container { display: flex; gap: 20px; margin-bottom: 20px; width: 100%; justify-content: space-around; }
        .stat-item { display: flex; flex-direction: column; align-items: center; min-width: 100px; }
        .stat-val { font-size: 2rem; font-weight: 800; margin-bottom: 5px; line-height: 1; transition: color 0.3s; }
        .stat-label { font-size: 0.8rem; color: #8b949e; text-transform: uppercase; }

        /* --- ç†±åŠ›åœ–èˆ‡äº’å‹• --- */
        .hover-info-bar {
            height: 24px;
            margin-bottom: 5px;
            font-size: 14px;
            color: #58a6ff;
            font-family: monospace;
            text-align: right;
            width: 100%;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        .graph-wrapper { padding: 15px; background: #161b22; border: 1px solid #30363d; border-radius: 10px; width: 100%; box-sizing: border-box; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .graph-container { display: grid; grid-template-rows: repeat(7, 12px); grid-auto-flow: column; gap: 3px; }
        .day-cell { width: 12px; height: 12px; border-radius: 2px; background-color: #21262d; outline: 1px solid rgba(255,255,255,0.05); cursor: crosshair; transition: transform 0.1s; }
        .color-gold { background-color: #ffd700 !important; z-index: 2; }
        @media (hover: hover) { .day-cell:hover { transform: scale(1.4); z-index: 10; border: 1px solid #fff; } }

        /* --- é€±æ¬¡å°èˆªèˆ‡æˆ°ç¸¾ Bar --- */
        .weekly-container {
            width: 100%; margin-top: 15px;
            background: rgba(22, 27, 34, 0.8);
            border: 1px solid #30363d; border-radius: 8px;
            display: flex; flex-direction: column; overflow: hidden;
            animation: fadeIn 0.5s ease;
        }
        .week-nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 15px; background: #21262d; border-bottom: 1px solid #30363d;
        }
        .nav-arrow { background: none; border: none; color: #8b949e; font-size: 18px; cursor: pointer; padding: 0 10px; transition: 0.2s; }
        .nav-arrow:hover { color: #fff; transform: scale(1.2); }
        
        .week-center-group { display: flex; align-items: center; gap: 8px; }
        .week-label { font-size: 14px; font-weight: bold; color: #e6edf3; }
        .nav-reset { 
            background: rgba(48, 54, 61, 0.5); border: 1px solid #30363d; border-radius: 4px; 
            color: #58a6ff; cursor: pointer; padding: 2px 8px; font-size: 12px; 
            display: none; 
            transition: 0.2s; 
        }
        .nav-reset:hover { background: #30363d; color: #fff; }
        
        .weekly-insight-content {
            padding: 15px; text-align: center; color: #58a6ff; font-size: 1.1rem; font-weight: 600;
        }
        .insight-highlight { color: #fff; font-weight: 800; margin: 0 5px; }

        /* --- é ç®—è¡€æ¢ --- */
        .budget-bar-container { width: 100%; box-sizing: border-box; margin-bottom: 20px; display: none; flex-direction: column; gap: 8px; background: #161b22; padding: 15px; border-radius: 12px; border: 1px solid #30363d; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .budget-header { display: flex; justify-content: space-between; align-items: flex-end; }
        .hp-track { width: 100%; height: 12px; background: #21262d; border-radius: 6px; overflow: hidden; position: relative; border: 1px solid #30363d; }
        .hp-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #2ea043, #3fb950); transition: width 0.5s; }
        .hp-fill.danger { background: linear-gradient(90deg, #da3633, #f85149); }

        /* --- ğŸ² çå‹µè½‰ç›¤ --- */
        .reward-card {
            background: #161b22; border: 1px solid #a371f7; border-radius: 12px; padding: 20px;
            width: 100%; box-sizing: border-box; text-align: center;
            box-shadow: 0 0 20px rgba(163, 113, 247, 0.1);
        }
        .reward-toggle-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .sub-toggle-btn { background: #21262d; border: 1px solid #30363d; color: #8b949e; padding: 6px 15px; border-radius: 15px; cursor: pointer; font-size: 13px; }
        .sub-toggle-btn.active-h { background: #238636; color: white; border-color: #238636; }
        .sub-toggle-btn.active-m { background: #d29922; color: #1e1e1e; border-color: #d29922; }

        .reward-period { font-size: 13px; color: #a371f7; margin-bottom: 5px; font-weight: bold; opacity: 0.8; }
        .balance-info { font-size: 1rem; color: #8b949e; margin-bottom: 5px; }
        .balance-amount { font-size: 2.5rem; font-weight: 800; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .result-box { margin: 20px 0; height: 80px; display: flex; align-items: center; justify-content: center; background: #0d1117; border: 2px dashed #30363d; border-radius: 8px; font-size: 1.5rem; font-weight: bold; color: #fff; }
        .result-box.win { border-color: #ffd700; color: #ffd700; animation: pop 0.3s; }
        .spin-btn { background: linear-gradient(135deg, #a371f7, #7e22ce); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(126, 34, 206, 0.4); transition: 0.2s; width: 100%; }
        .spin-btn:active { transform: scale(0.95); }
        .spin-btn:disabled { background: #30363d; cursor: not-allowed; box-shadow: none; }
        .reward-list-area { width: 100%; background: #0d1117; border: 1px solid #30363d; color: #8b949e; padding: 10px; border-radius: 6px; margin-top: 20px; min-height: 100px; font-family: monospace; font-size: 14px; resize: vertical; box-sizing: border-box; }

        /* --- Modal è¨­å®šé¢æ¿ --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #161b22; border: 1px solid #30363d; border-radius: 10px; padding: 25px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; box-sizing: border-box; }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #fff; }
        .input-group { margin-bottom: 15px; }
        .input-label { display: block; font-size: 12px; color: #8b949e; margin-bottom: 5px; }
        .input-field, .input-select { width: 100%; padding: 12px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; box-sizing: border-box; font-size: 14px; }
        .save-btn { width: 100%; padding: 12px; background: #238636; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 15px;}
        .note { font-size: 11px; color: #58a6ff; margin-top: 2px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop { 0% { transform: scale(0.8); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        @media (max-width: 600px) {
            body { padding: 10px; } .nav-bar { flex-direction: row; gap: 8px; } .switch-container { flex: 1; padding: 3px; } .switch-btn { padding: 8px 5px; font-size: 13px; flex: 1; text-align: center; } .stats-container { gap: 10px; } .stat-val { font-size: 1.5rem; } .graph-wrapper { padding: 10px; width: 100vw; margin-left: -10px; border-radius: 0; border-left: none; border-right: none;}
        }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="switch-container">
            <button class="switch-btn active" data-mode="health" onclick="switchApp('health')">ğŸ’ª ç†±é‡</button>
            <button class="switch-btn" data-mode="money" onclick="switchApp('money')">ğŸ’° è¨˜å¸³</button>
            <button class="switch-btn" data-mode="reward" onclick="switchApp('reward')">ğŸ² çå‹µ</button>
        </div>
        <button class="settings-btn" onclick="openSettings()">âš™ï¸</button>
    </div>

    <h2 id="app-title">Life Dashboard</h2>

    <div id="dashboard-view" class="dashboard-view">
        <div class="budget-bar-container" id="budget-container">
            <div class="budget-header">
                <span style="font-size:14px; font-weight:bold; color:#e6edf3;">ğŸ’³ éŒ¢åŒ… HP</span>
                <span style="font-size:12px; color:#8b949e;"><span id="wallet-hp">0</span> / <span id="wallet-max">0</span></span>
            </div>
            <div class="hp-track"><div class="hp-fill" id="hp-fill"></div></div>
            <div style="font-size:11px; color:#8b949e; text-align:right; margin-top:2px;">ä»Šæ—¥ç†è«–å‰©é¤˜: <span id="theory-hp">0</span></div>
        </div>

        <div class="quote-container" id="quote-card" onclick="refreshBanner()" title="ğŸ‘† é»æ“Šæ›´æ›é¢¨æ™¯èˆ‡åè¨€">
            <div class="quote-overlay" id="q-overlay"></div>
            <div class="quote-content-layer">
                <div class="quote-text" id="q-text"></div>
                <div class="quote-author" id="q-author"></div>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-item">
                <div id="stat1-val" class="stat-val">0</div>
                <div id="stat1-label" class="stat-label">é€£çºŒé”æ¨™ (å¤©)</div>
            </div>
            <div class="stat-item">
                <div id="stat2-val" class="stat-val">---</div>
                <div id="stat2-label" class="stat-label">ä»Šæ—¥æ•¸æ“š</div>
            </div>
            <div class="stat-item">
                <div id="stat3-val" class="stat-val">0</div>
                <div id="stat3-label" class="stat-label">ç¸½ç´€éŒ„å¤©æ•¸</div>
            </div>
        </div>

        <div class="hover-info-bar" id="hover-info">
            ğŸ‘† æ»‘å‹•ç†±åŠ›åœ–æŸ¥çœ‹è©³æƒ…
        </div>

        <div class="graph-wrapper" id="graph-scroller">
            <div id="heatmap" class="graph-container"></div>
        </div>
        
        <div class="weekly-container" id="weekly-container">
            <div class="week-nav">
                <button class="nav-arrow" onclick="changeWeek(-1)">â—€</button>
                <div class="week-center-group">
                    <div class="week-label" id="week-label">æœ¬é€±</div>
                    <button id="reset-week-btn" class="nav-reset" onclick="resetToCurrentWeek()" title="å›åˆ°æœ¬é€±">â†©</button>
                </div>
                <button class="nav-arrow" onclick="changeWeek(1)">â–¶</button>
            </div>
            <div id="weekly-equivalents" class="weekly-insight-content">
                è¨ˆç®—ä¸­...
            </div>
        </div>
    </div>

    <div id="reward-view" class="dashboard-view hidden">
        <div class="reward-card">
            <div class="reward-toggle-container">
                <button class="sub-toggle-btn" id="reward-health-btn" onclick="switchRewardContext('health')">ğŸ”¥ ç†±é‡çå‹µ</button>
                <button class="sub-toggle-btn" id="reward-money-btn" onclick="switchRewardContext('money')">ğŸ’° æ¶ˆè²»çå‹µ</button>
            </div>

            <div class="reward-period" id="reward-period-display"></div>
            
            <div class="balance-info" id="reward-title">è©²é€±ç´¯ç©æˆæœ</div>
            <div class="balance-amount" id="reward-balance">---</div>
            
            <div class="result-box" id="reward-result">?</div>
            
            <button class="spin-btn" onclick="spinWheel()">ğŸ° æŠ½å–çå‹µ</button>
            
            <div style="text-align:left; margin-top:20px; margin-bottom:5px; font-size:12px; color:#8b949e;">
                ğŸ‘‡ ç·¨è¼¯æ­¤æ¨¡å¼çš„çå“æ¸…å–® (ä¸€è¡Œä¸€å€‹)
            </div>
            <textarea id="reward-list-input" class="reward-list-area" oninput="saveRewardList()"></textarea>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal">
        <div class="modal-box">
            <div class="modal-title">âš™ï¸ è³‡æ–™ä¾†æºè¨­å®š</div>
            <div class="input-group"><label class="input-label">ç†±é‡è¡¨é€£çµ (æˆ– ID)</label><input type="text" id="input-health-id" class="input-field" placeholder="è²¼ä¸Šå®Œæ•´ç¶²å€æˆ– ID..."></div>
            <div class="input-group"><label class="input-label">ç†±é‡è¡¨åˆ†é å</label><input type="text" id="input-health-sheet" class="input-field" placeholder="é è¨­: è¡¨å–®"></div>
            <div style="border-top:1px solid #30363d; margin:15px 0;"></div>
            <div class="input-group"><label class="input-label">è¨˜å¸³è¡¨é€£çµ (æˆ– ID)</label><input type="text" id="input-money-id" class="input-field" placeholder="è²¼ä¸Šå®Œæ•´ç¶²å€æˆ– ID..."></div>
            <div class="input-group"><label class="input-label">è¨˜å¸³è¡¨åˆ†é å</label><input type="text" id="input-money-sheet" class="input-field" placeholder="é è¨­: è¡¨å–®"></div>
            <div class="input-group"><label class="input-label">è¨˜å¸³æœˆé ç®—</label><input type="number" id="input-monthly-budget" class="input-field" value="10000"></div>
            <div style="border-top:1px solid #30363d; margin:15px 0;"></div>
            <div class="input-group"><label class="input-label">é‡‘å¥åˆ†é å</label><input type="text" id="input-quote-sheet" class="input-field" placeholder="é è¨­: Quotes"></div>
            <div class="input-group">
                <label class="input-label">èƒŒæ™¯é¢¨æ ¼</label>
                <select id="input-bg-style" class="input-select">
                    <option value="nature" selected>ğŸŒ² éš¨æ©Ÿé¢¨æ™¯</option>
                    <option value="gradient">ğŸŒŒ ç§‘æŠ€æ¼¸å±¤</option>
                </select>
            </div>
            <button class="save-btn" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
            <div style="text-align:center; margin-top:10px; font-size:12px; color:#555; cursor:pointer;" onclick="closeSettings()">é—œé–‰</div>
        </div>
    </div>

    <script>
        let CONFIG = {
            healthId: '', healthSheet: 'è¡¨å–®',
            moneyId: '', moneySheet: 'è¡¨å–®',
            quoteSheet: 'Quotes',
            monthlyBudget: 10000,
            bgStyle: 'nature',
            rewardsHealth: "å–ä¸€æ¯å¥¶èŒ¶\nåƒç‚¸é›\nåƒç”œé»\nä¼‘æ¯ä¸€å¤©",
            rewardsMoney: "è²· Steam éŠæˆ²\næ­è¨ˆç¨‹è»Š\nè²·æ–°è¡£æœ\nåƒå¤§é¤"
        };
        
        let currentMode = 'health';
        let lastActiveMode = 'health'; 
        let globalDataMap = {};
        let globalTheme = {};
        let weekOffset = 0;
        let comparisonTicker = null; 

        // V19.2: ç¶œåˆé›»å½±åè¨€åº« (Love + Inspiration)
        const DEFAULT_QUOTES = [
            // Love (PopDaily)
            { text: "åªè¦è¨˜ä½ä½ çš„åå­—ï¼Œä¸ç®¡ä½ åœ¨ä¸–ç•Œçš„å“ªå€‹åœ°æ–¹ï¼Œæˆ‘ä¸€å®šæœƒå»è¦‹ä½ ã€‚", author: "ä½ çš„åå­—" },
            { text: "å¹¸ç¦æ˜¯æ¯ä¸€å€‹å¾®å°çš„ç”Ÿæ´»é¡˜æœ›é”æˆã€‚\nHappiness is having each tiny wish come true.", author: "å¤©å¤–å¥‡è¹Ÿ" },
            { text: "ä¸–ç•Œé€™éº¼å¤§ï¼Œäººç”Ÿé€™éº¼é•·ï¼Œç¸½æœƒæœ‰é€™éº¼ä¸€å€‹äººï¼Œè®“ä½ æƒ³è¦æº«æŸ”çš„å°å¾…ã€‚", author: "éœçˆ¾çš„ç§»å‹•åŸå ¡" },
            { text: "I love you. I knew it the minute I met you.\næˆ‘æ„›ä½ ï¼Œç•¶æˆ‘é‡è¦‹ä½ çš„é‚£ä¸€åˆ»å°±çŸ¥é“äº†ã€‚", author: "æ´¾ç‰¹çš„å¹¸ç¦åŠ‡æœ¬" },
            { text: "Life is not the amount of breaths you take, it's the moments that take your breath away.\näººç”Ÿä¸¦ä¸æ˜¯ä½ å‘¼å¸çš„æ¬¡æ•¸ï¼Œè€Œæ˜¯é‚£äº›ä»¤ä½ å±æ¯çš„æ™‚åˆ»ã€‚", author: "å…¨æ°‘æƒ…è–" },
            { text: "I'm just a girl, standing in front of a boy, asking him to love her.\næˆ‘åªæ˜¯ä¸€å€‹å¥³å­©ï¼Œç«™åœ¨ä¸€å€‹ç”·å­©çš„é¢å‰ï¼Œè«‹æ±‚ä»–æ„›å¥¹ã€‚", author: "æ–°å¨˜ç™¾åˆ†ç™¾" },
            { text: "Whatever happens tomorrow, we had today.\nç„¡è«–æ˜å¤©ç™¼ç”Ÿä»€éº¼äº‹ï¼Œè‡³å°‘æˆ‘å€‘æ“æœ‰ç•¶ä¸‹ã€‚", author: "çœŸæ„›æŒ‘æ—¥å­" },
            { text: "Call me by your name, and I'll call you by mine.\nä»¥ä½ çš„åå­—å‘¼å–šæˆ‘ï¼Œè€Œæˆ‘ä¹Ÿå°‡ä»¥æˆ‘çš„åå­—å–šä½ ã€‚", author: "ä»¥ä½ çš„åå­—å‘¼å–šæˆ‘" },
            { text: "We're all traveling through time together, every day of our lives.\næˆ‘å€‘ç”Ÿæ´»çš„æ¯ä¸€å¤©ï¼Œéƒ½æ˜¯åœ¨ç©¿è¶Šæ™‚ç©ºã€‚", author: "çœŸæ„›æ¯ä¸€å¤©" },
            { text: "You complete meï¼\nä½ å®Œæ•´äº†æˆ‘çš„äººç”Ÿã€‚", author: "å¾æœæƒ…æµ·" },
            { text: "You have bewitched me, body and soul, andâ€¦ I love you.\nä½ å°æˆ‘ä¸‹äº†é­”å’’ï¼Œè®“æˆ‘çš„å¿ƒéˆèˆ‡èº«é«”éƒ½ç‚ºä½ è‘—è¿·ã€‚", author: "å‚²æ…¢èˆ‡åè¦‹" },
            { text: "I want all of you, forever, you and me, every day.\næˆ‘æƒ³è¦å…¨éƒ¨çš„ä½ ï¼Œä¸€è¼©å­ã€æ¯ä¸€å¤©å°±åªæœ‰ä½ è·Ÿæˆ‘ã€‚", author: "æ‰‹æœ­æƒ…ç·£" },
            { text: "I want it all. And to have it all, we have to risk it all.\næˆ‘æƒ³å…¨éƒ¨æ“æœ‰ã€‚è€Œè¦æ“æœ‰ä¸€åˆ‡ï¼Œæˆ‘å€‘å°±å¿…é ˆæ”¾æ‰‹ä¸€åšã€‚", author: "æ„›çš„éå»é€²è¡Œå¼" },
            { text: "Love heals what logic or reason cannot.\næ„›èƒ½ç™’åˆé‚£äº›ï¼Œé‚è¼¯æˆ–ç†ç”±æ‰€ä¸èƒ½çš„ã€‚", author: "æ„›çš„è¬ç‰©è«–" },
            
            // Inspiration & Perseverance (PrepEdu)
            { text: "Our greatest glory is not in never falling, but in rising every time we fall.\næˆ‘å€‘æœ€å¤§çš„æ¦®è€€ä¸åœ¨æ–¼å¾æœªè·Œå€’ï¼Œè€Œåœ¨æ–¼æ¯æ¬¡è·Œå€’å¾Œéƒ½èƒ½é‡æ–°ç«™èµ·ã€‚", author: "è™è ä¿ ï¼šé–‹æˆ°æ™‚åˆ»" },
            { text: "It's not about how hard you hit. It's about how hard you can get hit and keep moving forward.\né‡é»ä¸åœ¨æ–¼ä½ èƒ½æ‰“å¾—å¤šé‡ï¼Œè€Œåœ¨æ–¼ä½ èƒ½æ‰¿å—å¤šé‡çš„æ‰“æ“Šï¼Œä¸¦æŒçºŒå‰é€²ã€‚", author: "æ´›åŸºï¼šå‹‡è€…ç„¡æ‡¼" },
            { text: "The only thing standing between you and your goal is the story you keep telling yourself as to why you can't achieve it.\næ©«äº™åœ¨ä½ èˆ‡ç›®æ¨™ä¹‹é–“çš„å”¯ä¸€éšœç¤™ï¼Œå°±æ˜¯ä½ ä¸æ–·å‘Šè¨´è‡ªå·±ç„¡æ³•é”æˆçš„é‚£å€‹æ•…äº‹ã€‚", author: "è¯çˆ¾è¡—ä¹‹ç‹¼" },
            { text: "I have not failed. I've just found 10,000 ways that won't work.\næˆ‘æ²’æœ‰å¤±æ•—ï¼Œæˆ‘åªæ˜¯æ‰¾åˆ°äº†ä¸€è¬ç¨®è¡Œä¸é€šçš„æ–¹æ³•ã€‚", author: "ç•¶å¹¸ç¦ä¾†æ•²é–€" },
            { text: "Pain is temporary. Quitting lasts forever.\nç—›è‹¦æ˜¯æš«æ™‚çš„ï¼Œæ”¾æ£„å»æ˜¯æ°¸æ†çš„ã€‚", author: "é¢å°å·¨äºº" },
            { text: "Success is not final, failure is not fatal: it is the courage to continue that counts.\næˆåŠŸä¸æ˜¯çµ‚é»ï¼Œå¤±æ•—ä¹Ÿéè‡´å‘½ï¼Œé‡è¦çš„æ˜¯ç¹¼çºŒå‰é€²çš„å‹‡æ°£ã€‚", author: "è‡³æš—æ™‚åˆ»" },
            { text: "You must do the things you think you cannot do.\nä½ å¿…é ˆå»åšé‚£äº›ä½ èªç‚ºè‡ªå·±åšä¸åˆ°çš„äº‹ã€‚", author: "æ°¸ä¸å¦¥å”" },
            { text: "It always seems impossible until it's done.\nåœ¨å®Œæˆä¹‹å‰ï¼Œä¸€åˆ‡ç¸½æ˜¯çœ‹ä¼¼ä¸å¯èƒ½ã€‚", author: "æ‰“ä¸å€’çš„å‹‡è€…" },
            { text: "Fall seven times, stand up eight.\nè·Œå€’ä¸ƒæ¬¡ï¼Œç¬¬å…«æ¬¡ç«™èµ·ä¾†ã€‚", author: "æœ«ä»£æ­¦å£«" },
            { text: "Don't ever let somebody tell you you can't do something.\næ°¸é ä¸è¦è®“ä»»ä½•äººå‘Šè¨´ä½ ï¼Œä½ åšä¸åˆ°æŸä»¶äº‹ã€‚", author: "ç•¶å¹¸ç¦ä¾†æ•²é–€" },
            { text: "If you're going through hell, keep going.\nå¦‚æœä½ æ­£åœ¨ç¶“æ­·åœ°ç„ï¼Œé‚£å°±ç¹¼çºŒå‰é€²ã€‚", author: "è‡³æš—æ™‚åˆ»" },
            { text: "Every champion was once a contender who refused to give up.\næ¯å€‹å† è»éƒ½æ›¾æ˜¯æ‹’çµ•æ”¾æ£„çš„æŒ‘æˆ°è€…ã€‚", author: "æ´›åŸºï¼šå‹‡è€…ç„¡æ‡¼" },
            { text: "Keep your eyes on the stars, and your feet on the ground.\nä»°æœ›æ˜Ÿç©ºï¼Œè…³è¸å¯¦åœ°ã€‚", author: "ç™»æœˆå…ˆé‹’" },
            
            // Dreams & Potential
            { text: "Your time is limited, don't waste it living someone else's life.\nä½ çš„æ™‚é–“æœ‰é™ï¼Œåˆ¥æµªè²»åœ¨éåˆ¥äººçš„ç”Ÿæ´»ä¸Šã€‚", author: "è³ˆä¼¯æ–¯" },
            { text: "Go confidently in the direction of your dreams. Live the life you have imagined.\nè‡ªä¿¡åœ°æœè‘—å¤¢æƒ³å‰é€²ï¼Œéä½ æƒ³åƒä¸­çš„ç”Ÿæ´»ã€‚", author: "ç™½æ—¥å¤¢å†’éšªç‹" },
            { text: "If you can dream it, you can do it.\nå¦‚æœä½ èƒ½å¤¢æƒ³å®ƒï¼Œä½ å°±èƒ½å¯¦ç¾å®ƒã€‚", author: "æ˜æ—¥ä¸–ç•Œ" },
            { text: "Believe you can and you're halfway there.\nç›¸ä¿¡ä½ å¯ä»¥ï¼Œä½ å°±å·²ç¶“æˆåŠŸä¸€åŠäº†ã€‚", author: "å¥‡è¹Ÿç”·å­©" },
            { text: "The best way to predict the future is to create it.\né æ¸¬æœªä¾†çš„æœ€å¥½æ–¹æ³•å°±æ˜¯å‰µé€ å®ƒã€‚", author: "å›åˆ°æœªä¾†" },
            { text: "Start where you are. Use what you have. Do what you can.\nå¾ä½ æ‰€åœ¨ä¹‹è™•é–‹å§‹ï¼Œç”¨ä½ æ“æœ‰çš„ï¼Œåšä½ èƒ½åšçš„ã€‚", author: "ç•¶å¹¸ç¦ä¾†æ•²é–€" },
            { text: "It does not matter how slowly you go as long as you do not stop.\nåªè¦ä¸åœæ­¢ï¼Œèµ°å¾—å¤šæ…¢éƒ½ç„¡æ‰€è¬‚ã€‚", author: "åŠŸå¤«ç†Šè²“" },
            { text: "Believe in yourself. You are braver than you think, more talented than you know, and capable of more than you imagine.\nç›¸ä¿¡è‡ªå·±ï¼Œä½ æ¯”æƒ³åƒä¸­æ›´å‹‡æ•¢ã€æ›´æœ‰æ‰è¯ã€æ›´æœ‰èƒ½åŠ›ã€‚", author: "å°ç†Šç¶­å°¼" },
            { text: "Magic is believing in yourself. If you can do that, you can make anything happen.\né­”æ³•å°±æ˜¯ç›¸ä¿¡è‡ªå·±ï¼Œå¦‚æœä½ èƒ½åšåˆ°é€™é»ï¼Œå°±èƒ½è®“ä»»ä½•äº‹ç™¼ç”Ÿã€‚", author: "å°é£›è±¡" },
            { text: "You are the one thing you have power over.\nä½ æ˜¯å”¯ä¸€èƒ½æŒæ§çš„äº‹ç‰©ã€‚", author: "é­”æ³•æ»¿å±‹" },
            
            // Wisdom & Growth
            { text: "Life is like a box of chocolates. You never know what you're gonna get.\näººç”Ÿå°±åƒä¸€ç›’å·§å…‹åŠ›ï¼Œä½ æ°¸é ä¸çŸ¥é“æœƒå¾—åˆ°ä»€éº¼ã€‚", author: "é˜¿ç”˜æ­£å‚³" },
            { text: "After all, tomorrow is another day.\nç•¢ç«Ÿï¼Œæ˜å¤©åˆæ˜¯æ–°çš„ä¸€å¤©ã€‚", author: "äº‚ä¸–ä½³äºº" },
            { text: "Hope is a good thing, maybe the best of things, and no good thing ever dies.\nå¸Œæœ›æ˜¯å¥½æ±è¥¿ï¼Œä¹Ÿè¨±æ˜¯æœ€å¥½çš„æ±è¥¿ï¼Œå¥½æ±è¥¿æ°¸é ä¸æœƒæ¶ˆé€ã€‚", author: "åˆºæ¿€1995" },
            { text: "The past can hurt. But the way I see it, you can either run from it or learn from it.\néå»æœƒå‚·äººï¼Œä½†æˆ‘èªç‚ºï¼Œä½ å¯ä»¥é¸æ“‡é€ƒé¿æˆ–å¾ä¸­å­¸ç¿’ã€‚", author: "ç…å­ç‹" },
            { text: "Happiness can be found even in the darkest of times, if one only remembers to turn on the light.\nå³ä½¿åœ¨æœ€é»‘æš—çš„æ™‚åˆ»ä¹Ÿèƒ½æ‰¾åˆ°å¿«æ¨‚ï¼Œåªè¦è¨˜å¾—é»äº®ç‡ˆå…‰ã€‚", author: "å“ˆåˆ©æ³¢ç‰¹ï¼šé˜¿èŒ²å¡ç­çš„é€ƒçŠ¯" },
            { text: "It is our choices that show what we truly are, far more than our abilities.\nå±•ç¾æˆ‘å€‘çœŸå¯¦æœ¬è³ªçš„ï¼Œæ˜¯æˆ‘å€‘çš„é¸æ“‡ï¼Œé å‹æ–¼æˆ‘å€‘çš„èƒ½åŠ›ã€‚", author: "å“ˆåˆ©æ³¢ç‰¹ï¼šæ¶ˆå¤±çš„å¯†å®¤" },
            { text: "We are who we choose to be.\næˆ‘å€‘æ˜¯æˆ‘å€‘é¸æ“‡æˆç‚ºçš„äººã€‚", author: "èœ˜è››äºº" },
            { text: "The flower that blooms in adversity is the rarest and most beautiful of all.\nåœ¨é€†å¢ƒä¸­ç¶»æ”¾çš„èŠ±æœµï¼Œæ˜¯æœ€ç¨€æœ‰ä¹Ÿæœ€ç¾éº—çš„ã€‚", author: "èŠ±æœ¨è˜­" },
            { text: "Change is nature's way of giving us a chance to try something new.\næ”¹è®Šæ˜¯å¤§è‡ªç„¶çµ¦æˆ‘å€‘å˜—è©¦æ–°äº‹ç‰©çš„æ©Ÿæœƒã€‚", author: "åŠŸå¤«ç†Šè²“3" },
            { text: "The only thing predictable about life is its unpredictability.\näººç”Ÿå”¯ä¸€å¯é æ¸¬çš„å°±æ˜¯å®ƒçš„ä¸å¯é æ¸¬æ€§ã€‚", author: "æ–™ç†é¼ ç‹" },
            { text: "Sometimes the right path is not the easiest one.\næœ‰æ™‚å€™æ­£ç¢ºçš„é“è·¯ä¸æ˜¯æœ€å®¹æ˜“çš„é‚£æ¢ã€‚", author: "é¢¨ä¸­å¥‡ç·£" }
        ];

        const THEMES = {
            health: { 
                colors: ['#0e4429', '#26a641', '#39d353', '#161b22', '#490c0c', '#a82020', '#ff4d4d'], 
                statLabels: ['é€£çºŒé”æ¨™ (å¤©)', 'ä»Šæ—¥èµ¤å­— (CAL)', 'ç¸½ç´€éŒ„å¤©æ•¸'], 
                isDeficitGood: true, 
                thresholds: [-600, -300, 0, 300, 600], 
                unit: 'cal',
                goldLimit: -500 
            },
            money: { 
                colors: ['#0e4429', '#26a641', '#161b22', '#d29922', '#bd561d', '#ff4d4d'], 
                statLabels: ['çœéŒ¢é”æ¨™ (å¤©)', 'ä»Šæ—¥èŠ±è²» ($)', 'ç¸½ç´€éŒ„å¤©æ•¸'], 
                isDeficitGood: false, 
                budgetLimit: 300, 
                goldLimit: 170, 
                thresholds: [100, 300, 800, 1500, 3000], 
                unit: '$' 
            }
        };

        init();

        function init() {
            loadSettings();
            setRandomFallbackQuote(); 
            applyDefaultBackground(); 
            if (!CONFIG.healthId && !CONFIG.moneyId) openSettings();
            else switchApp('health');
            document.getElementById('reward-list-input').value = CONFIG.rewardsHealth;
        }

        function setRandomFallbackQuote() {
            const r = DEFAULT_QUOTES[Math.floor(Math.random() * DEFAULT_QUOTES.length)];
            document.getElementById('q-text').innerText = r.text;
            document.getElementById('q-author').innerText = r.author;
        }

        function openSettings() {
            document.getElementById('input-health-id').value = CONFIG.healthId || '';
            document.getElementById('input-health-sheet').value = CONFIG.healthSheet || 'è¡¨å–®';
            document.getElementById('input-money-id').value = CONFIG.moneyId || '';
            document.getElementById('input-money-sheet').value = CONFIG.moneySheet || 'è¡¨å–®';
            document.getElementById('input-monthly-budget').value = CONFIG.monthlyBudget || 10000;
            document.getElementById('input-bg-style').value = CONFIG.bgStyle || 'nature';
            document.getElementById('input-quote-sheet').value = CONFIG.quoteSheet || 'Quotes';
            document.getElementById('settings-modal').style.display = 'flex';
        }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        
        function saveSettings() {
            const extractId = (val) => {
                if (!val) return '';
                const match = val.match(/\/d\/([a-zA-Z0-9-_]+)/);
                return match ? match[1] : val;
            };

            CONFIG.healthId = extractId(document.getElementById('input-health-id').value.trim());
            CONFIG.healthSheet = document.getElementById('input-health-sheet').value.trim() || 'è¡¨å–®';
            CONFIG.moneyId = extractId(document.getElementById('input-money-id').value.trim());
            CONFIG.moneySheet = document.getElementById('input-money-sheet').value.trim() || 'è¡¨å–®';
            CONFIG.monthlyBudget = parseInt(document.getElementById('input-monthly-budget').value) || 10000;
            CONFIG.bgStyle = document.getElementById('input-bg-style').value;
            CONFIG.quoteSheet = document.getElementById('input-quote-sheet').value.trim() || 'Quotes';
            
            localStorage.setItem('dashboard_config_v11', JSON.stringify(CONFIG));
            closeSettings();
            applyDefaultBackground();
            switchApp(currentMode);
        }
        
        function loadSettings() {
            const saved = localStorage.getItem('dashboard_config_v11');
            if (saved) {
                CONFIG = JSON.parse(saved);
                if (!CONFIG.rewardsHealth) CONFIG.rewardsHealth = "å–ä¸€æ¯å¥¶èŒ¶\nåƒç‚¸é›";
                if (!CONFIG.rewardsMoney) CONFIG.rewardsMoney = "è²·éŠæˆ²\nçœ‹é›»å½±";
            }
        }

        function saveRewardList() {
            const content = document.getElementById('reward-list-input').value;
            if (currentMode === 'health') CONFIG.rewardsHealth = content;
            else CONFIG.rewardsMoney = content;
            localStorage.setItem('dashboard_config_v11', JSON.stringify(CONFIG));
        }

        function applyDefaultBackground() {
            const card = document.getElementById('quote-card');
            const overlay = document.getElementById('q-overlay');
            if (CONFIG.bgStyle === 'nature') {
                const day = new Date().getDate();
                card.style.backgroundImage = `url('https://loremflickr.com/800/300/nature,landscape?lock=${day}')`; 
                overlay.style.display = 'block';
            } else {
                card.style.backgroundImage = 'linear-gradient(135deg, #21262d 0%, #0d1117 100%)';
                overlay.style.display = 'none';
            }
        }

        // V19.1: é»æ“Šåˆ·æ–° (åœ–ç‰‡+æ–‡å­—)
        function refreshBanner() {
            setRandomFallbackQuote();
            if (CONFIG.bgStyle !== 'nature') return;
            const card = document.getElementById('quote-card');
            card.style.backgroundImage = `url('https://loremflickr.com/800/300/nature,landscape?random=${Date.now()}')`;
        }

        function switchApp(mode) {
            currentMode = mode;
            weekOffset = 0; 
            document.querySelectorAll('.switch-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === mode));
            
            if (comparisonTicker) { clearInterval(comparisonTicker); comparisonTicker = null; }

            const dashView = document.getElementById('dashboard-view');
            const rewardView = document.getElementById('reward-view');

            if (mode === 'reward') {
                dashView.classList.add('hidden');
                rewardView.classList.remove('hidden');
                document.getElementById('app-title').innerText = "ğŸ² Reward Center";
                
                if(lastActiveMode) {
                    currentMode = lastActiveMode; 
                    updateWeeklyInsight(0); 
                    switchRewardContext(lastActiveMode);
                    currentMode = 'reward'; 
                }
                return;
            }

            lastActiveMode = mode; 
            dashView.classList.remove('hidden');
            rewardView.classList.add('hidden');
            
            globalTheme = THEMES[mode]; 
            const sheetId = (mode === 'health') ? CONFIG.healthId : CONFIG.moneyId;
            const sheetName = (mode === 'health') ? CONFIG.healthSheet : CONFIG.moneySheet;
            
            document.getElementById('app-title').innerText = (mode === 'health') ? "ğŸ”¥ Calorie Tracker" : "ğŸ’° Expense Tracker";
            document.getElementById('heatmap').innerHTML = 'Loading data...';
            document.getElementById('hover-info').innerText = 'ğŸ‘† æ»‘å‹•ç†±åŠ›åœ–æŸ¥çœ‹è©³æƒ…'; 
            
            document.getElementById('stat1-label').innerText = globalTheme.statLabels[0];
            document.getElementById('stat2-label').innerText = globalTheme.statLabels[1];
            document.getElementById('stat3-label').innerText = globalTheme.statLabels[2];
            
            document.getElementById('budget-container').style.display = (mode === 'money') ? 'flex' : 'none';
            
            if (sheetId) {
                fetchData(sheetId, sheetName, globalTheme);
                fetchQuotes(sheetId, CONFIG.quoteSheet);
            } else {
                document.getElementById('heatmap').innerHTML = '<div style="padding:20px; text-align:center; color:#888;">è«‹é»æ“Šå³ä¸Šè§’ âš™ï¸ è¨­å®š Sheet ID</div>';
            }
        }

        function changeWeek(offset) {
            weekOffset += offset;
            updateWeeklyInsight(weekOffset);
        }

        function resetToCurrentWeek() {
            weekOffset = 0;
            updateWeeklyInsight(0);
        }

        function updateWeeklyInsight(offset) {
            const now = new Date();
            const targetToday = new Date(now);
            targetToday.setDate(now.getDate() + (offset * 7));
            
            const startOfWeek = new Date(targetToday);
            const day = targetToday.getDay();
            const diff = targetToday.getDate() - day + (day === 0 ? -6 : 1); 
            startOfWeek.setDate(diff);
            startOfWeek.setHours(0,0,0,0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); 
            endOfWeek.setHours(23,59,59,999);

            const fmt = (d) => `${d.getMonth()+1}/${d.getDate()}`;
            const label = (offset === 0) ? `æœ¬é€± (${fmt(startOfWeek)} - ${fmt(endOfWeek)})` : 
                          (offset === -1) ? `ä¸Šé€± (${fmt(startOfWeek)} - ${fmt(endOfWeek)})` : 
                          `é€± (${fmt(startOfWeek)} - ${fmt(endOfWeek)})`;
            document.getElementById('week-label').innerText = label;
            document.getElementById('reward-period-display').innerText = `ğŸ“… çµç®—é€±æœŸ: ${label}`;

            const resetBtn = document.getElementById('reset-week-btn');
            if(offset === 0) resetBtn.style.display = 'none';
            else resetBtn.style.display = 'block';

            let weekSum = 0;
            let ptr = new Date(startOfWeek);
            while(ptr <= endOfWeek) {
                const dStr = ptr.toISOString().split('T')[0];
                if (globalDataMap[dStr]) {
                    if (globalTheme.isDeficitGood) {
                         if(globalDataMap[dStr].value < 0) weekSum += globalDataMap[dStr].value;
                    } else {
                         weekSum += globalDataMap[dStr].value;
                    }
                }
                ptr.setDate(ptr.getDate() + 1);
            }

            const weeklyBar = document.getElementById('weekly-equivalents');
            if (comparisonTicker) { clearInterval(comparisonTicker); comparisonTicker = null; }

            if (currentMode === 'health' || (currentMode === 'reward' && lastActiveMode === 'health')) {
                const weeklyDeficit = Math.abs(weekSum);
                if (weekSum < 0) {
                     const comparisons = [
                        { text: 'ğŸ¥¤ å°‘å–äº†', unit: 'æ¯çå¥¶', val: Math.round(weeklyDeficit / 650) },
                        { text: 'ğŸ— å°‘åƒäº†', unit: 'å¡Šé›æ’', val: Math.round(weeklyDeficit / 600) },
                        { text: 'ğŸ” å°‘åƒäº†', unit: 'å€‹å¤§éº¥å…‹', val: Math.round(weeklyDeficit / 550) },
                        { text: 'ğŸš å°‘åƒäº†', unit: 'ç¢—ç™½é£¯', val: Math.round(weeklyDeficit / 280) }
                    ];
                    let cIndex = 0;
                    const updateBar = () => {
                        const item = comparisons[cIndex];
                        weeklyBar.innerHTML = `${label}æˆ°ç¸¾ï¼š${item.text} <span class="insight-highlight">${item.val}</span> ${item.unit}`;
                        cIndex = (cIndex + 1) % comparisons.length;
                    };
                    updateBar();
                    comparisonTicker = setInterval(updateBar, 3000);
                } else {
                    weeklyBar.innerHTML = `${label}ï¼šå°šæœªç´¯ç©èµ¤å­—`;
                }
                updateRewardUI(Math.abs(weekSum), globalTheme.unit, true);

            } else {
                const weeklyBudget = CONFIG.monthlyBudget / 4;
                const saved = weeklyBudget - weekSum;
                if (saved > 0) {
                     const comparisons = [
                        { text: 'â˜• çœä¸‹äº†', unit: 'æ¯æ˜Ÿå·´å…‹', val: Math.round(saved / 150) },
                        { text: 'ğŸ± çœä¸‹äº†', unit: 'å€‹ä¾¿ç•¶', val: Math.round(saved / 100) },
                        { text: 'ğŸ¬ çœä¸‹äº†', unit: 'å¼µé›»å½±ç¥¨', val: Math.round(saved / 300) },
                        { text: 'ğŸ® çœä¸‹äº†', unit: 'ç‰‡éŠæˆ²', val: (saved / 1500).toFixed(1) }
                    ];
                    let cIndex = 0;
                    const updateBar = () => {
                        const item = comparisons[cIndex];
                        weeklyBar.innerHTML = `${label}æˆ°ç¸¾ï¼š${item.text} <span class="insight-highlight">${item.val}</span> ${item.unit}`;
                        cIndex = (cIndex + 1) % comparisons.length;
                    };
                    updateBar();
                    comparisonTicker = setInterval(updateBar, 3000);
                } else {
                     const over = Math.abs(saved);
                     weeklyBar.innerHTML = `${label}æˆ°ç¸¾ï¼šğŸ’¸ è¶…æ”¯äº† <span class="insight-highlight">${over}</span> å…ƒ (å°‘åƒ ${Math.round(over/100)} å€‹ä¾¿ç•¶)`;
                }
                updateRewardUI(Math.round(saved), globalTheme.unit, saved >= 0);
            }
        }

        function updateRewardUI(val, unit, isGood) {
            const el = document.getElementById('reward-balance');
            if(el) {
                el.innerText = `${val} ${unit}`;
                el.style.color = isGood ? '#3fb950' : '#ff4d4d';
            }
        }

        function switchRewardContext(type) {
            document.getElementById('reward-health-btn').classList.toggle('active-h', type === 'health');
            document.getElementById('reward-money-btn').classList.toggle('active-m', type === 'money');
            
            const title = (type === 'health') ? 'ğŸ”¥ è©²é€±ç†±é‡èµ¤å­—' : 'ğŸ’° è©²é€±å‰©é¤˜é ç®—';
            document.getElementById('reward-title').innerText = title;
            document.getElementById('reward-list-input').value = (type === 'health') ? CONFIG.rewardsHealth : CONFIG.rewardsMoney;
        }

        function spinWheel() {
            const listText = document.getElementById('reward-list-input').value.trim();
            if (!listText) return alert('è«‹å…ˆè¼¸å…¥çå“æ¸…å–®ï¼');
            const items = listText.split('\n').filter(line => line.trim() !== '');
            const resultBox = document.getElementById('reward-result');
            const btn = document.querySelector('.spin-btn');
            if (items.length === 0) return;

            btn.disabled = true;
            resultBox.classList.remove('win');
            let count = 0;
            let speed = 50;

            const loop = setInterval(() => {
                const rand = items[Math.floor(Math.random() * items.length)];
                resultBox.innerText = rand;
                count++;
                if (count > 20) { 
                    clearInterval(loop);
                    btn.disabled = false;
                    resultBox.classList.add('win');
                }
            }, speed);
        }

        async function fetchData(id, sheetName, theme) {
            const encodedSheet = encodeURIComponent(sheetName);
            const url = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&sheet=${encodedSheet}&tq=SELECT B, C OFFSET 1`;
            try {
                const res = await fetch(url); const text = await res.text();
                const jsonString = text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\);/)[1];
                const data = JSON.parse(jsonString);
                processData(data.table.rows, theme);
            } catch (error) { 
                console.error(error); 
                document.getElementById('heatmap').innerHTML = `è®€å–å¤±æ•—: è«‹ç¢ºèªåˆ†é åç¨± "${sheetName}" æ˜¯å¦æ­£ç¢º`; 
            }
        }

        function processData(rows, theme) {
            globalDataMap = {}; 
            
            let count = 0; let streak = 0; const now = new Date(); let monthSpent = 0;
            const offset = now.getTimezoneOffset() * 60000;
            const todayStr = new Date(now.getTime() - offset).toISOString().split('T')[0];
            
            rows.forEach(row => {
                if (!row.c[0] || row.c[1] === null) return;
                let dateStr = ""; let dateVal = row.c[0].v;
                try {
                    if (typeof dateVal === 'string' && dateVal.includes("Date")) { const parts = dateVal.match(/Date\((\d+),(\d+),(\d+)\)/); dateStr = new Date(parts[1], parts[2], parts[3]).toISOString().split('T')[0]; } 
                    else { 
                        const d = new Date(row.c[0].f || row.c[0].v);
                        if(isNaN(d.getTime())) return;
                        dateStr = d.toISOString().split('T')[0]; 
                    }
                } catch(e) { return; }

                const value = row.c[1].v; 
                if (globalDataMap[dateStr]) { globalDataMap[dateStr].value += value; } 
                else { globalDataMap[dateStr] = { value: value }; }
            });
            
            const sortedDates = Object.keys(globalDataMap).sort();
            sortedDates.forEach(dateStr => {
                const item = globalDataMap[dateStr];
                const value = item.value;
                const itemDate = new Date(dateStr);
                if (itemDate.getMonth() === now.getMonth() && itemDate.getFullYear() === now.getFullYear()) { monthSpent += value; }
                count++;
            });

            if (sortedDates.length > 0) {
                for (let i = sortedDates.length - 1; i >= 0; i--) {
                    const d = sortedDates[i]; const val = globalDataMap[d].value;
                    if (new Date(d) > new Date()) continue; 
                    let isSuccess = false;
                    if (theme.isDeficitGood) isSuccess = (val < 0);
                    else isSuccess = (val <= theme.budgetLimit && val > 0) || (val <= theme.goldLimit);
                    if (isSuccess) { streak++; if (i > 0) { const curr = new Date(d); const prev = new Date(sortedDates[i-1]); if (Math.abs(curr - prev) / (1000*60*60*24) > 1.5) break; }} else { break; }
                }
            }

            document.getElementById('stat1-val').innerText = streak;
            document.getElementById('stat1-val').style.color = theme.isDeficitGood ? '#ff9b5e' : '#d29922';

            const todayItem = globalDataMap[todayStr];
            const todayEl = document.getElementById('stat2-val');
            if (todayItem) {
                const val = todayItem.value;
                todayEl.innerText = val.toLocaleString();
                if (theme.isDeficitGood) {
                    todayEl.style.color = (val < 0) ? '#3fb950' : '#ff4d4d'; 
                } else {
                    todayEl.style.color = (val <= theme.budgetLimit) ? '#3fb950' : '#ff4d4d'; 
                }
            } else {
                todayEl.innerText = "å¾…è¼¸å…¥";
                todayEl.style.color = "#8b949e";
            }

            document.getElementById('stat3-val').innerText = count.toLocaleString();
            document.getElementById('stat3-val').style.color = '#58a6ff';

            if (currentMode === 'money') {
                updateWalletHP(monthSpent, CONFIG.monthlyBudget);
            }
            
            drawHeatmap(globalDataMap, theme);
            setTimeout(() => { const scroller = document.getElementById('graph-scroller'); if(scroller) scroller.scrollLeft = scroller.scrollWidth; }, 100);
            updateWeeklyInsight(0);
        }

        function updateWalletHP(spent, budget) {
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const currentDay = now.getDate();
            const remaining = budget - spent;
            const hpPercent = Math.max(0, (remaining / budget) * 100);
            const theoryRemaining = budget * ((daysInMonth - currentDay) / daysInMonth);
            document.getElementById('wallet-hp').innerText = remaining.toLocaleString();
            document.getElementById('wallet-max').innerText = budget.toLocaleString();
            document.getElementById('theory-hp').innerText = Math.round(theoryRemaining).toLocaleString();
            const bar = document.getElementById('hp-fill');
            bar.style.width = hpPercent + '%';
            if (remaining < theoryRemaining * 0.9) { bar.className = 'hp-fill danger'; } else { bar.className = 'hp-fill'; }
        }

        function drawHeatmap(data, theme) {
            const container = document.getElementById('heatmap'); container.innerHTML = '';
            const today = new Date(); const startDate = new Date(); startDate.setDate(today.getDate() - 365);
            while (startDate.getDay() !== 1) startDate.setDate(startDate.getDate() - 1);
            
            let currentDate = new Date(startDate);
            const hoverBar = document.getElementById('hover-info');

            while (currentDate <= today) {
                const dateString = currentDate.toISOString().split('T')[0];
                const item = data[dateString];
                const cell = document.createElement('div');
                cell.classList.add('day-cell');
                cell.style.backgroundColor = theme.colors[theme.isDeficitGood ? 3 : 2]; 
                
                if (item !== undefined) {
                    const value = item.value; const th = theme.thresholds; let verdict = "";
                    if (theme.isDeficitGood) {
                        if (value <= theme.goldLimit) { cell.classList.add('color-gold'); verdict = "ğŸ”¥ ç‡ƒè„‚"; }
                        else if (value < th[0]) cell.style.backgroundColor = theme.colors[0];
                        else if (value < th[1]) cell.style.backgroundColor = theme.colors[1];
                        else if (value < 0) cell.style.backgroundColor = theme.colors[2];
                        else if (value == 0) cell.style.backgroundColor = theme.colors[3];
                        else if (value < th[3]) cell.style.backgroundColor = theme.colors[4];
                        else if (value < th[4]) cell.style.backgroundColor = theme.colors[5];
                        else cell.style.backgroundColor = theme.colors[6];
                    } else {
                        if (value <= theme.goldLimit && value > 0) { cell.classList.add('color-gold'); verdict = "ğŸ† ç¥çœ"; }
                        else if (value === 0) cell.style.backgroundColor = theme.colors[2];
                        else if (value <= th[1]) { cell.style.backgroundColor = theme.colors[1]; verdict = "âœ… å®‰å…¨"; }
                        else if (value <= th[2]) { cell.style.backgroundColor = theme.colors[3]; }
                        else if (value <= th[3]) { cell.style.backgroundColor = theme.colors[4]; }
                        else cell.style.backgroundColor = theme.colors[5];
                    }

                    const tooltipText = `${dateString} | ${verdict} ${theme.unit}: ${value}`;
                    cell.setAttribute('title', tooltipText);
                    cell.onmouseover = () => { hoverBar.innerText = tooltipText; hoverBar.style.color = '#fff'; };
                    cell.onmouseout = () => { hoverBar.innerText = 'ğŸ‘† æ»‘å‹•ç†±åŠ›åœ–æŸ¥çœ‹è©³æƒ…'; hoverBar.style.color = '#58a6ff'; };
                }
                container.appendChild(cell);
                currentDate.setDate(currentDate.getDate() + 1);
            }
        }

        async function fetchQuotes(id, sheetName) {
            // V19.1: å³ä½¿æœ‰ IDï¼Œä¹Ÿå°‡éš¨æ©Ÿåè¨€ä½œç‚º Fallbackï¼Œæˆ–æ··ç”¨
            // é€™è£¡é‚è¼¯æ”¹ç‚ºï¼šå¦‚æœæœ‰ Google Sheet è³‡æ–™ï¼Œå„ªå…ˆä½¿ç”¨ï¼Œå¤±æ•—å‰‡ç”¨éš¨æ©Ÿåº«
            // ä½†ä½¿ç”¨è€…å¸Œæœ›ã€Œé»æ“Šåˆ‡æ›ã€ï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥åœ¨ refreshBanner å‡½å¼ä¸­åšæ‰‹è…³
            
            if (!id || !sheetName) { 
                setRandomFallbackQuote(); 
                return; 
            }
            const url = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&sheet=${sheetName}&tq=SELECT A, B, C`;
            try {
                const res = await fetch(url); const text = await res.text();
                const jsonString = text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\);/)[1];
                const data = JSON.parse(jsonString);
                if (data.table.rows.length > 0) {
                    // å¦‚æœæœ‰ Sheet è³‡æ–™ï¼Œå°‡å…¶åŠ å…¥ DEFAULT_QUOTES æ“´å……åè¨€åº«
                    data.table.rows.forEach(row => {
                        const qText = row.c[0] ? row.c[0].v : "";
                        const qAuth = row.c[1] ? row.c[1].v : "";
                        if(qText) DEFAULT_QUOTES.push({ text: qText, author: qAuth });
                    });
                    
                    // ç„¶å¾Œéš¨æ©Ÿé¡¯ç¤ºä¸€å€‹
                    setRandomFallbackQuote();

                    const qImg  = data.table.rows[0].c[2] ? data.table.rows[0].c[2].v : null; // å–ç¬¬ä¸€å¼µåœ–æˆ–éš¨æ©Ÿ? é€™è£¡ç¶­æŒåŸé‚è¼¯
                    if (CONFIG.bgStyle === 'custom' && qImg) { 
                        const card = document.getElementById('quote-card');
                        const overlay = document.getElementById('q-overlay');
                        card.style.backgroundImage = `url('${qImg}')`; 
                        overlay.style.display = 'block'; 
                    }
                }
            } catch (e) { setRandomFallbackQuote(); }
        }
    </script>
</body>
</html>
